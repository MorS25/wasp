

## Defines a number of per-test-program Makefile variables.
## Some are just intermediates, but nice to have (?)
define TESTPROG_template
  ##
  ## List of all the testcase source files
  ## Generated by expanding any wildcares in (testprog)_TESTSRCS
  $(1)_TESTSRCX = $$(wildcard $$($(1)_TESTSRCS))
  ##
  ## Full paths of intermediate testcase source files
  ## Generated by gen-testsuite.py and placed in bin directory
  $(1)_TESTSRCO = $$(addprefix $$(OBJDIR)/,$$(addsuffix _test.c,$$(basename $$($(1)_TESTSRCX))))
  ##
  ## Full paths to object files which result from (testprog)_TESTSRCO
  $(1)_TESTOBJO = $$(addsuffix .o,$$(basename $$($(1)_TESTSRCO)))
  ##
  ## Full paths to object files for application sources
  $(1)_OBJO = $$(addprefix $$(OBJDIR)/,$$(addsuffix .o,$$(basename $$($(1)_SRCS))))
  ##
  ## Full path to top-level source file generated by gen-testmain.py
  $(1)_MAINSRC = $$(OBJDIR)/$$(addsuffix .c,$(1))
  ##
  ## Full path to resulting binary
  $(1)_BIN     = $$(OBJDIR)/$(1)
  OBJDIR_TEST_PROGS += $$($(1)_BIN)
  CLEAN_OBJ += $$($(1)_TESTOBJO) $$($(1)_MAINSRC) $$($(1)_BIN) $$($(1)_TESTSRCO)
  ##
  ## Dependencies for top-level binary
  $$(OBJDIR)/$(1): $$($(1)_MAINSRC) $$($(1)_TESTOBJO) $$($(1)_OBJO)
  ##
  ## Dependencies for top-level source file
  $$($(1)_MAINSRC): $$($(1)_TESTSRCO)
endef

$(foreach prog, $(TEST_PROGS), $(eval $(call TESTPROG_template,$(prog))))


test: testprogs
	$(Q)$(GTESTER) --verbose $(OBJDIR_TEST_PROGS)

testprogs: $(OBJDIR_TEST_PROGS)

$(OBJDIR)/$(TEST_PROGS): 
	$(Q)$(CC) $(CFLAGS) `pkg-config --cflags glib-2.0` `pkg-config --libs glib-2.0` -o $@ $^

$(OBJDIR_TEST_PROGS:%=%.c): $(TOOLS)/gen-testsuite.py
	$(Q)test -d $(dir $@) || mkdir -p $(dir $@)
	$(Q)$(TOOLS)/gen-testmain.py $(filter-out $<,$^) > $@

$(OBJDIR)/%_test.c: $(TOOLS)/gen-testsuite.py %.c
	$(Q)test -d $(dir $@) || mkdir -p $(dir $@)
	$(Q)$(TOOLS)/gen-testsuite.py $(filter-out $<,$^) > $@

%_test.o: %_test.c
	$(CC) -c $(CFLAGS) -o $@  $^


